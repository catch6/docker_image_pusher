name: Build Custom Images

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'docker/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ALIYUN_REGISTRY: '${{ secrets.ALIYUN_REGISTRY }}'
  ALIYUN_NAME_SPACE: '${{ secrets.ALIYUN_NAME_SPACE }}'
  ALIYUN_REGISTRY_USER: '${{ secrets.ALIYUN_REGISTRY_USER }}'
  ALIYUN_REGISTRY_PASSWORD: '${{ secrets.ALIYUN_REGISTRY_PASSWORD }}'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - id: set-matrix
        run: |
          # 查找所有需要构建的 Docker 镜像目录
          # 格式: docker/image-name/tag/Dockerfile
          IMAGES=$(find docker -type f -name "Dockerfile" | sed 's|docker/\(.*\)/\(.*\)/Dockerfile|\1:\2|' | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix=${IMAGES}" >> $GITHUB_OUTPUT

  build-and-push:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
      max-parallel: 10

    steps:
      - name: Free up disk space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 20480
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          build-mount-path: '/var/lib/docker/'

      - name: Restart docker
        run: sudo service docker restart

      - name: Docker Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Build and Push Image
        run: |
          docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

          # 从矩阵中获取镜像信息
          image_info="${{ matrix.image }}"
          echo "Processing: $image_info"

          # 分离镜像名称和标签
          IFS=':' read -r image_name image_tag <<< "$image_info"
          echo "Image name: $image_name"
          echo "Image tag: $image_tag"

          # 确定 Dockerfile 路径和构建上下文
          dockerfile_path="docker/$image_name/$image_tag/Dockerfile"
          context_path="docker/$image_name/$image_tag"
          echo "Dockerfile path: $dockerfile_path"

          # 检查 Dockerfile 是否存在
          if [ ! -f "$dockerfile_path" ]; then
            echo "Dockerfile not found: $dockerfile_path"
            exit 1
          fi

          # 构建推送到阿里云的镜像名称
          aliyun_image_name="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$image_name:$image_tag"
          echo "Building and pushing: $aliyun_image_name"

          # 使用 buildx 构建并直接推送（带重试）
          for i in 1 2 3; do
            docker buildx build --push \
              --provenance=false \
              -t "$aliyun_image_name" \
              -f "$dockerfile_path" \
              "$context_path" && break
            echo "Build/push failed, retrying in 10s... ($i/3)"
            sleep 10
          done
